use simpy_rs::Simulator;
use tracing_subscriber;

#[tokio::main]
async fn main() -> Result<(), Box<dyn std::error::Error>> {
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
    tracing_subscriber::fmt::init();

    // –°–æ–∑–¥–∞–µ–º —Å–∏–º—É–ª—è—Ç–æ—Ä
    let mut sim = Simulator::new();

    // –°–æ–∑–¥–∞–µ–º —Ä–µ—Å—É—Ä—Å—ã
    sim.create_resource("–∫–∞—Å—Å–∏—Ä", 2).await;
    sim.create_resource("–±–∞–Ω–∫–æ–º–∞—Ç", 3).await;

    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–∫—Ä–∏–ø—Ç –∫–ª–∏–µ–Ω—Ç–∞ 1
    let client1_script = r#"
        function client1()
            log("–ö–ª–∏–µ–Ω—Ç 1 –ø—Ä–∏—à–µ–ª –≤ –±–∞–Ω–∫ –≤ " .. now() .. " —Å–µ–∫", "info")
            log("–ö–ª–∏–µ–Ω—Ç 1 –∏–¥–µ—Ç –∫ –∫–∞—Å—Å–∏—Ä—É", "debug")
            request("–∫–∞—Å—Å–∏—Ä")
            log("–ö–ª–∏–µ–Ω—Ç 1 –ø–æ–ª—É—á–∏–ª –∫–∞—Å—Å–∏—Ä–∞, –æ–±—Å–ª—É–∂–∏–≤–∞–µ—Ç—Å—è", "info")
            wait(5)
            release("–∫–∞—Å—Å–∏—Ä")
            log("–ö–ª–∏–µ–Ω—Ç 1 –æ–±—Å–ª—É–∂–µ–Ω –∏ —É—Ö–æ–¥–∏—Ç –≤ " .. now() .. " —Å–µ–∫", "info")
        end
    "#;

    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–∫—Ä–∏–ø—Ç –∫–ª–∏–µ–Ω—Ç–∞ 2
    let client2_script = r#"
        function client2()
            wait(2)  -- –ø—Ä–∏—Ö–æ–¥–∏—Ç —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã
            log("–ö–ª–∏–µ–Ω—Ç 2 –ø—Ä–∏—à–µ–ª –≤ –±–∞–Ω–∫ –≤ " .. now() .. " —Å–µ–∫", "info")
            log("–ö–ª–∏–µ–Ω—Ç 2 –∏–¥–µ—Ç –∫ –±–∞–Ω–∫–æ–º–∞—Ç—É", "debug")
            request("–±–∞–Ω–∫–æ–º–∞—Ç")
            log("–ö–ª–∏–µ–Ω—Ç 2 –ø–æ–ª—É—á–∏–ª –±–∞–Ω–∫–æ–º–∞—Ç, –æ–±—Å–ª—É–∂–∏–≤–∞–µ—Ç—Å—è", "info")
            wait(3)
            release("–±–∞–Ω–∫–æ–º–∞—Ç")
            log("–ö–ª–∏–µ–Ω—Ç 2 –æ–±—Å–ª—É–∂–µ–Ω –∏ —É—Ö–æ–¥–∏—Ç –≤ " .. now() .. " —Å–µ–∫", "info")
        end
    "#;

    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–∫—Ä–∏–ø—Ç –∫–ª–∏–µ–Ω—Ç–∞ 3
    let client3_script = r#"
        function client3()
            wait(3)  -- –ø—Ä–∏—Ö–æ–¥–∏—Ç —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
            log("–ö–ª–∏–µ–Ω—Ç 3 –ø—Ä–∏—à–µ–ª –≤ –±–∞–Ω–∫ –≤ " .. now() .. " —Å–µ–∫", "info")
            log("–ö–ª–∏–µ–Ω—Ç 3 –∏–¥–µ—Ç –∫ –∫–∞—Å—Å–∏—Ä—É", "debug")
            request("–∫–∞—Å—Å–∏—Ä")
            log("–ö–ª–∏–µ–Ω—Ç 3 –ø–æ–ª—É—á–∏–ª –∫–∞—Å—Å–∏—Ä–∞, –æ–±—Å–ª—É–∂–∏–≤–∞–µ—Ç—Å—è", "info")
            wait(4)
            release("–∫–∞—Å—Å–∏—Ä")
            log("–ö–ª–∏–µ–Ω—Ç 3 –æ–±—Å–ª—É–∂–µ–Ω –∏ —É—Ö–æ–¥–∏—Ç –≤ " .. now() .. " —Å–µ–∫", "info")
        end
    "#;

    // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å—ã
    sim.load_process("client1", client1_script, "client1").await?;
    sim.load_process("client2", client2_script, "client2").await?;
    sim.load_process("client3", client3_script, "client3").await?;

    println!("üè¶ –°–∏–º—É–ª—è—Ü–∏—è –±–∞–Ω–∫–∞");
    println!("==================");
    
    // –ó–∞–ø—É—Å–∫–∞–µ–º —Å–∏–º—É–ª—è—Ü–∏—é
    sim.run(20.0).await?;

    // –í—ã–≤–æ–¥–∏–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
    let stats = sim.get_stats().await;
    println!("\nüìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–∏–º—É–ª—è—Ü–∏–∏:");
    println!("{}", serde_json::to_string_pretty(&stats)?);

    Ok(())
}
